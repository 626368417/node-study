# Docker (äºŒ)

# 1. Docker ç½‘ç»œ

### 1.1 ç®€ä»‹

**ä¸ºä»€ä¹ˆéœ€è¦ Docker ç½‘ç»œç®¡ç†**

#### **1. å®¹å™¨é€šä¿¡éœ€æ±‚ï¼ˆåŸºç¡€åŠ¨åŠ›ï¼‰**

- **å®¹å™¨äº’è”äº’é€š**

  - å¾®æœåŠ¡æ¶æ„ä¸‹ä¸åŒå®¹å™¨ï¼ˆå¦‚ Web å‰ç«¯ + æ•°æ®åº“ + ç¼“å­˜ï¼‰éœ€ç›¸äº’é€šä¿¡ï¼š

  ```bash
  # åˆ›å»ºå®¹å™¨æ—¶è‡ªåŠ¨è¿æ¥é»˜è®¤ç½‘ç»œ
  docker run -d --name web nginx
  docker run -d --name mysql -e MYSQL_ROOT_PASSWORD=123 mysql
  ```

- **æœåŠ¡å‘ç°æœºåˆ¶**
  - å®¹å™¨é€šè¿‡**å®¹å™¨åç§°è‡ªåŠ¨ DNS è§£æ**ï¼Œæ— éœ€è®°å½• IPï¼ˆå¦‚ `mysql:3306`ï¼‰

#### **2. ç½‘ç»œéš”ç¦»ï¼ˆå®‰å…¨å…³é”®ï¼‰**

|     åœºæ™¯     |        éœ€æ±‚        |           Docker å®ç°            |
| :----------: | :----------------: | :------------------------------: |
|  å¤šé¡¹ç›®ç¯å¢ƒ  | éš”ç¦»å¼€å‘/æµ‹è¯•/ç”Ÿäº§ | `docker network create prod-net` |
| æ•æ„ŸæœåŠ¡éš”ç¦» | æ•°æ®åº“ä¸ä¸å‰ç«¯ç›´è¿ |         åˆ’åˆ†ç‹¬ç«‹ç½‘ç»œåˆ†åŒº         |
|   å®‰å…¨é˜²æŠ¤   |  é™åˆ¶éæ³•è®¿é—®è·¯å¾„  |     é»˜è®¤ç½‘ç»œç­–ç•¥é˜»æ–­è·¨ç½‘é€šä¿¡     |

#### **3. å†…å¤–ç½‘ç»œè¿æ¥ï¼ˆæœåŠ¡æš´éœ²ï¼‰**

- **å…¥ç«™è®¿é—®æ§åˆ¶**
  - **å…¥ç«™è®¿é—®æ§åˆ¶**

```bash
docker run -d -p 80:8080 myapp  # å®¿ä¸»æœº80ç«¯å£æ˜ å°„åˆ°å®¹å™¨8080
```

- **å‡ºç«™ç½‘ç»œç­–ç•¥**
  - æ§åˆ¶å®¹å™¨è®¿é—®å¤–ç½‘æƒé™

```bash
docker network create no-internet --internal
```

#### **4. å¤šä¸»æœºç»„ç½‘ï¼ˆåˆ†å¸ƒå¼æ‰©å±•ï¼‰**

- **è·¨èŠ‚ç‚¹å®¹å™¨é€šä¿¡**
  - Swarm/Kubernetes é›†ç¾¤ä¸­å®¹å™¨éœ€è·¨ç‰©ç†æœºäº’é€šï¼š

```bash
docker network create -d overlay cluster-net
```

- **ç½‘ç»œæ’ä»¶é›†æˆ**
  - è·¨äº‘ç½‘ç»œäº’é€š
  - å¾®éš”ç¦»ç­–ç•¥
  - ç½‘ç»œæ€§èƒ½ç›‘æ§

#### **5. æµé‡ç®¡æ§ï¼ˆè¿ç»´ä¿éšœï¼‰**

```mermaid
graph TD
    A[å®¹å™¨A] -->|å¸¦å®½é™åˆ¶ 10Mbps| B[ç½‘å…³]
    C[å®¹å™¨B] -->|æœ€é«˜ä¼˜å…ˆçº§| B
    D[å®¹å™¨C] -->|æœ€ä½ä¼˜å…ˆçº§| B
```

- **QoS ä¿éšœ**ï¼šå…³é”®ä¸šåŠ¡å®¹å™¨ä¼˜å…ˆé€šè¡Œ
- **å¸¦å®½é™åˆ¶**ï¼šé˜²æ­¢å•å®¹å™¨è€—å°½å¸¦å®½
- **æµé‡ç›‘æ§**ï¼š`docker stats` å®æ—¶è§‚æµ‹

### 1.2 Docker ä¸­æœ‰å“ªäº›ç½‘ç»œé©±åŠ¨æ¨¡å¼

**Docker æœ‰äº”ç§ç½‘ç»œé©±åŠ¨æ¨¡å¼**

- bridge network æ¨¡å¼ï¼ˆç½‘æ¡¥ï¼‰ï¼šé»˜è®¤çš„ç½‘ç»œæ¨¡å¼ã€‚ç±»ä¼¼è™šæ‹Ÿæœºçš„ nat æ¨¡å¼
- host network æ¨¡å¼ï¼ˆä¸»æœºï¼‰ï¼šå®¹å™¨ä¸å®¿ä¸»æœºä¹‹é—´çš„ç½‘ç»œæ— éš”ç¦»ï¼Œå³å®¹å™¨ç›´æ¥ä½¿ç”¨å®¿ä¸»æœºç½‘ç»œ
- None network æ¨¡å¼ï¼šå®¹å™¨ç¦ç”¨æ‰€æœ‰ç½‘ç»œã€‚
- Overlay network æ¨¡å¼ï¼ˆè¦†ç›–ç½‘ç»œï¼‰ï¼š åˆ©ç”¨ VXLAN å®ç°çš„ bridge æ¨¡å¼

- Macvlan network æ¨¡å¼ï¼šå®¹å™¨å…·å¤‡ Mac åœ°å€ï¼Œä½¿å…¶æ˜¾ç¤ºä¸ºç½‘ç»œä¸Šçš„ç‰©ç†è®¾å¤‡

### 1.3Docker ç½‘ç»œç®¡ç†å‘½ä»¤

#### 1. æŸ¥çœ‹ç½‘ç»œ â€“ docker network ls

- **ä½œç”¨**ï¼šæŸ¥çœ‹å·²ç»å»ºç«‹çš„ç½‘ç»œå¯¹è±¡

- **å‘½ä»¤æ ¼å¼**ï¼šdocker network ls [OPTIONS]

- **å‘½ä»¤å‚æ•°ï¼ˆOPTIONSï¼‰**ï¼š
- -f, --filter filter è¿‡æ»¤æ¡ä»¶(å¦‚ 'driver=bridgeâ€™)
- --format string æ ¼å¼åŒ–æ‰“å°ç»“æœ
- --no-trunc ä¸ç¼©ç•¥æ˜¾ç¤º

- -q, --quiet åªæ˜¾ç¤ºç½‘ç»œå¯¹è±¡çš„ ID

```bash
# æŸ¥çœ‹ç½‘ç»œ(é»˜è®¤æƒ…å†µä¸‹ï¼Œdockerå®‰è£…å®Œæˆåï¼Œä¼šè‡ªåŠ¨åˆ›å»ºbridgeã€hostã€noneä¸‰ç§ç½‘ç»œé©±åŠ¨)
[root@lavm-zo7f3xq5c6 ~]# docker network ls
NETWORK ID     NAME      DRIVER    SCOPE
cf440d390e12   bridge    bridge    local
77af46120087   host      host      local
7f7b53529fb3   none      null      local

```

#### 2. åˆ›å»ºç½‘ç»œ â€“ docker network create

- **ä½œç”¨**ï¼šåˆ›å»ºæ–°çš„ç½‘ç»œå¯¹è±¡

- **å‘½ä»¤æ ¼å¼**ï¼šdocker network create [OPTIONS] NETWORK

- **å‘½ä»¤å‚æ•°ï¼ˆOPTIONSï¼‰**ï¼š

  - -d, --driver string æŒ‡å®šç½‘ç»œçš„é©±åŠ¨(é»˜è®¤ "bridge")

  - --format string æŒ‡å®šå­ç½‘ç½‘æ®µ(å¦‚ 192.168.0.0/16ã€172.88.0.0/24)

  - --no-trunc æ‰§è¡Œå®¹å™¨çš„ IP èŒƒå›´ï¼Œæ ¼å¼åŒ subnet å‚æ•°

  - -q, --quiet å­ç½‘çš„ IPv4 or IPv6 ç½‘å…³ï¼Œå¦‚(192.168.0.1)

```bash
# åˆ›å»º ç½‘ç»œ bridgeæ¨¡å¼
[root@lavm-zo7f3xq5c6 ~]# docker network create -d bridge  my-bridge
f5e6b44a050cbd486bc4b76084100927ae69349d5face6a2213f1e46844c3cdf
# æŸ¥çœ‹ç½‘ç»œ
[root@lavm-zo7f3xq5c6 ~]# docker network ls
NETWORK ID     NAME        DRIVER    SCOPE
cf440d390e12   bridge      bridge    local
77af46120087   host        host      local
f5e6b44a050c   my-bridge   bridge    local
7f7b53529fb3   none        null      local

# hostå’Œnoneæ¨¡å¼ç½‘ç»œåªèƒ½å­˜åœ¨ä¸€ä¸ª
# åˆ›å»º ç½‘ç»œ hostæ¨¡å¼
[root@lavm-zo7f3xq5c6 ~]# docker network create -d host  my-host
Error response from daemon: only one instance of "host" network is allowed
# åˆ›å»º ç½‘ç»œ noneæ¨¡å¼
[root@lavm-zo7f3xq5c6 ~]# docker network create -d null  my-null
Error response from daemon: only one instance of "null" network is allowed
# åˆ›å»º ç½‘ç»œ overlay
[root@lavm-zo7f3xq5c6 ~]# docker network create -d overlay  my-overlay
# dockerè‡ªå¸¦çš„overlay ç½‘ç»œåˆ›å»ºä¾èµ–äºdocker swarm(é›†ç¾¤è´Ÿè½½å‡è¡¡)æœåŠ¡
Error response from daemon: This node is not a swarm manager. Use "docker swarm init" or "docker swarm join" to connect this node to swarm and try again.
# åˆ›å»º ç½‘ç»œ macvlanæ¨¡å¼
[root@lavm-zo7f3xq5c6 ~]# docker network create -d macvlan  my-macvlan
d670a3bf8e2adfa4ecda3504c7a07f8591905e436aeed9224b9ef73b1d893e52
# æŸ¥çœ‹ç½‘ç»œ
[root@lavm-zo7f3xq5c6 ~]# docker network ls
NETWORK ID     NAME         DRIVER    SCOPE
cf440d390e12   bridge       bridge    local
77af46120087   host         host      local
f5e6b44a050c   my-bridge    bridge    local
d670a3bf8e2a   my-macvlan   macvlan   local
7f7b53529fb3   none         null      local


```

#### 3. ç½‘ç»œåˆ é™¤ â€“ docker network rm

- **ä½œç”¨**ï¼šåˆ é™¤ä¸€ä¸ªæˆ–å¤šä¸ªç½‘ç»œ

- **å‘½ä»¤æ ¼å¼**ï¼šdocker network rm NETWORK [NETWORK...]

- **å‘½ä»¤å‚æ•°ï¼ˆOPTIONSï¼‰**ï¼š

```bash
# åˆ é™¤ my-macvlan
docker network rm my-macvlan
```

#### 4.æŸ¥çœ‹ç½‘ç»œè¯¦ç»†ä¿¡æ¯ â€“ docker network inspect

- **ä½œç”¨**ï¼šæŸ¥çœ‹ä¸€ä¸ªæˆ–å¤šä¸ªç½‘ç»œçš„è¯¦ç»†ä¿¡æ¯
- **å‘½ä»¤æ ¼å¼**ï¼šdocker network inspect [OPTIONS] NETWORK [NETWORK...]
- **å‘½ä»¤å‚æ•°ï¼ˆOPTIONSï¼‰**ï¼š

  - -f, --format string æ ¹æ® format è¾“å‡ºç»“æœ

```bash

#
docker  inspect  bridge
#
[root@lavm-zo7f3xq5c6 ~]# docker  network  inspect -f '{{index .IPAM.Config }}' bridge
[{172.17.0.0/16  172.17.0.1 map[]}]

```

#### 5.ä½¿ç”¨ç½‘ç»œ â€“ docker run --network

- **ä½œç”¨**ï¼šä¸ºå¯åŠ¨çš„å®¹å™¨æŒ‡å®šç½‘ç»œæ¨¡å¼
- **å‘½ä»¤æ ¼å¼**ï¼šdocker run/create --network NETWORK
- **å‘½ä»¤å‚æ•°ï¼ˆOPTIONSï¼‰**ï¼š

```bash
# centosä½¿ç”¨my-bridgeç½‘ç»œ
docker run --network  my-bridge  -dti centos bash
```

#### 6.ç½‘ç»œè¿æ¥ä¸æ–­å¼€ â€“ docker network connect/disconnect

- **ä½œç”¨**ï¼šå°†æŒ‡å®šå®¹å™¨ä¸æŒ‡å®šç½‘ç»œè¿›è¡Œè¿æ¥æˆ–è€…æ–­å¼€è¿æ¥
- **å‘½ä»¤æ ¼å¼**ï¼šdocker network connect /disconnect [OPTIONS] NETWORK CONTAINER
- **å‘½ä»¤å‚æ•°ï¼ˆOPTIONSï¼‰**ï¼š
  - -f, --force å¼ºåˆ¶æ–­å¼€è¿æ¥(ç”¨äº disconnect)

```bash
 # æ–­å¼€
 docker network disconnect my-bridge centos
 # è¿æ¥
  docker network disconnect my-bridge centos
```

### 1.4 Docker ç½‘ç»œæ¨¡å¼ç®€ä»‹

#### 1. bridge ç½‘ç»œæ¨¡å¼

**ç‰¹ç‚¹**

- å®¿ä¸»æœºä¸Šéœ€è¦å•ç‹¬çš„ bridge ç½‘å¡ï¼Œå¦‚é»˜è®¤ docker é»˜è®¤åˆ›å»ºçš„ docker0ã€‚
- å®¹å™¨ä¹‹é—´ã€å®¹å™¨ä¸ä¸»æœºä¹‹é—´çš„ç½‘ç»œé€šä¿¡ï¼Œæ˜¯å€ŸåŠ©ä¸ºæ¯ä¸€ä¸ªå®¹å™¨ç”Ÿæˆçš„ä¸€å¯¹ veth pair è™šæ‹Ÿç½‘ç»œè®¾å¤‡å¯¹ï¼Œè¿›è¡Œé€šä¿¡çš„ã€‚ä¸€ä¸ªåœ¨å®¹å™¨ä¸Šï¼Œå¦ä¸€ä¸ªåœ¨å®¿ä¸»æœºä¸Š
- æ¯åˆ›å»ºä¸€ä¸ªåŸºäº bridge ç½‘ç»œçš„å®¹å™¨ï¼Œéƒ½ä¼šè‡ªåŠ¨åœ¨å®¿ä¸»æœºä¸Šåˆ›å»ºä¸€ä¸ª veth\*\*è™šæ‹Ÿç½‘ç»œè®¾å¤‡

- å¤–éƒ¨æ— æ³•ç›´æ¥è®¿é—®å®¹å™¨ã€‚éœ€è¦å»ºç«‹ç«¯å£æ˜ å°„æ‰èƒ½è®¿é—®ã€‚

- å®¹å™¨å€Ÿç”± veth è™šæ‹Ÿè®¾å¤‡é€šè¿‡å¦‚ docker0 è¿™ç§ bridge ç½‘ç»œè®¾å¤‡è¿›è¡Œé€šä¿¡ã€‚

- æ¯ä¸€å®¹å™¨å…·æœ‰å•ç‹¬çš„ IP
  ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/1c494461018342b0809cedf731806765.png)

  ##### ç«¯å£æ˜ å°„ â€“ docker run/create -P

- **ä½œç”¨**ï¼šå¯åŠ¨çš„å®¹å™¨æ—¶ï¼Œä¸ºå®¹å™¨è¿›è¡Œç«¯å£æ˜ å°„
- **å‘½ä»¤æ ¼å¼**ï¼šdocker run/create -P
- **å‘½ä»¤å‚æ•°ï¼ˆOPTIONSï¼‰**ï¼š
  - -P(å¤§å†™), --publish-all å°†å®¹å™¨å†…éƒ¨æ‰€æœ‰æš´éœ²ç«¯å£è¿›è¡Œéšæœºæ˜ å°„
  - -pï¼ˆå°å†™ï¼‰, --publish list æ‰‹åŠ¨æŒ‡å®šç«¯å£æ˜ å°„

```bash

# è¿è¡Œ redis
docker run -dti -P redis
# éšæœºæ˜ å°„ ä¸»æœº=ã€‹å®¹å™¨ ç«¯å£
0.0.0.0:36271->6379/tcp,

#è¿è¡Œ redis
docker run -dti -p :6379:6379 redis

# æŒ‡å®š ä¸»æœº=ã€‹å®¹å™¨ ç«¯å£
0.0.0.0:6379->6379/tcp,
```

#### 2.host ç½‘ç»œæ¨¡å¼

**ç‰¹ç‚¹**

- å®¹å™¨å®Œå…¨å…±äº«å®¿ä¸»æœºçš„ç½‘ç»œã€‚ç½‘ç»œæ²¡æœ‰éš”ç¦»ã€‚å®¿ä¸»æœºçš„ç½‘ç»œå°±æ˜¯å®¹å™¨çš„ç½‘ç»œ
- å®¹å™¨ã€ä¸»æœºä¸Šçš„åº”ç”¨æ‰€ä½¿ç”¨çš„ç«¯å£ä¸èƒ½é‡å¤ã€‚ä¾‹å¦‚ï¼šå¦‚æœå®¿ä¸»æœºå·²ç»å ç”¨äº† 8090 ç«¯å£ï¼Œé‚£ä¹ˆä»»ä½•ä¸€ä¸ª host æ¨¡å¼çš„å®¹å™¨éƒ½ä¸å¯ä»¥ä½¿ç”¨ 8090 ç«¯å£äº†ï¼›åä¹‹åŒç†ã€‚

- å¤–éƒ¨å¯ä»¥ç›´æ¥è®¿é—®å®¹å™¨ï¼Œä¸éœ€è¦ç«¯å£æ˜ å°„ã€‚
- å®¹å™¨çš„ IP å°±æ˜¯å®¿ä¸»æœºçš„ IP

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/3dfd522ec6554d6c9449205e089803b1.png)

#### 3. none ç½‘ç»œæ¨¡å¼

**ç‰¹ç‚¹**

- å®¹å™¨ä¸Šæ²¡æœ‰ç½‘ç»œï¼Œä¹Ÿæ— ä»»ä½•ç½‘ç»œè®¾å¤‡ã€‚
- å¦‚æœéœ€è¦ä½¿ç”¨ç½‘ç»œï¼Œéœ€è¦ç”¨æˆ·è‡ªè¡Œå®‰è£…ä¸é…ç½®ã€‚

**åº”ç”¨åœºæ™¯**

- è¯¥æ¨¡å¼é€‚åˆéœ€è¦é«˜åº¦å®šåˆ¶ç½‘ç»œçš„ç”¨æˆ·ä½¿ç”¨ã€‚

#### 4.overlay ç½‘ç»œæ¨¡å¼

**ç‰¹ç‚¹**

- Overlay ç½‘ç»œï¼Œä¹Ÿç§°ä¸ºè¦†ç›–ç½‘ç»œã€‚
- Overlay ç½‘ç»œçš„å®ç°æ–¹å¼å’Œæ–¹æ¡ˆæœ‰å¤šç§ã€‚Docker è‡ªèº«é›†æˆäº†ä¸€ç§ï¼ŒåŸºäº VXLAN éš§é“æŠ€æœ¯å®ç°ã€‚
- Overlay ç½‘ç»œä¸»è¦ç”¨äºå®ç°è·¨ä¸»æœºå®¹å™¨ä¹‹é—´çš„é€šä¿¡ã€‚

**åº”ç”¨åœºæ™¯**

- éœ€è¦ç®¡ç†æˆç™¾ä¸Šåƒä¸ªè·¨ä¸»æœºçš„å®¹å™¨é›†ç¾¤çš„ç½‘ç»œæ—¶ã€‚

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/2052a680349a433ca416695c2b3d1430.png)

#### 5. macvlan ç½‘ç»œæ¨¡å¼

**ç‰¹ç‚¹**

- macvlan ç½‘ç»œæ¨¡å¼ï¼Œæœ€ä¸»è¦çš„ç‰¹å¾å°±æ˜¯ä»–ä»¬çš„é€šä¿¡ä¼šç›´æ¥åŸºäº mac åœ°å€è¿›è¡Œè½¬å‘
- è¿™æ—¶å®¿ä¸»æœºå…¶å®å……å½“ä¸€ä¸ªäºŒå±‚äº¤æ¢æœºã€‚Docker ä¼šç»´æŠ¤ç€ä¸€ä¸ª MAC åœ°å€è¡¨ï¼Œå½“å®¿ä¸»æœºç½‘ç»œæ”¶åˆ°ä¸€ä¸ªæ•°æ®åŒ…åï¼Œç›´æ¥æ ¹æ® mac åœ°å€æ‰¾åˆ°å¯¹åº”çš„å®¹å™¨ï¼Œå†æŠŠæ•°æ®äº¤ç»™å¯¹åº”çš„å®¹å™¨ã€‚
- å®¹å™¨ä¹‹é—´å¯ä»¥ç›´æ¥é€šè¿‡ IP äº’é€šï¼Œé€šè¿‡å®¿ä¸»æœºä¸Šå†…å»ºçš„è™šæ‹Ÿç½‘ç»œè®¾å¤‡ï¼ˆåˆ›å»º macvlan ç½‘ç»œæ—¶è‡ªåŠ¨åˆ›å»ºï¼‰ï¼Œä½†ä¸ä¸»æœºæ— æ³•ç›´æ¥åˆ©ç”¨ IP äº’é€šã€‚

**åº”ç”¨åœºæ™¯**

- ç”±äºæ¯ä¸ªå¤–æ¥çš„æ•°æ®åŒ…çš„ç›®çš„ mac åœ°å€å°±æ˜¯å®¹å™¨çš„ mac åœ°å€ï¼Œè¿™æ—¶æ¯ä¸ªå®¹å™¨å¯¹äºå¤–é¢ç½‘ç»œæ¥è¯´å°±ç›¸å½“äºä¸€ä¸ªçœŸå®çš„ç‰©ç†ç½‘ç»œè®¾å¤‡ã€‚å› æ­¤å½“éœ€è¦è®©å®¹å™¨æ¥çš„ç½‘ç»œçœ‹èµ·æ¥æ˜¯ä¸€ä¸ªçœŸå®çš„ç‰©ç†æœºæ—¶ï¼Œä½¿ç”¨ macvlan æ¨¡å¼
  ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/c866c991715d45cb98bb7057fcef377d.png)

## 2.Docker æ•°æ®å·

### 1. Docker æ•°æ®å·ç®€ä»‹

**ä¸ºä»€ä¹ˆéœ€è¦æ•°æ®å·**

**ä¸€ã€è§£å†³å®¹å™¨æ•°æ®ä¸¢å¤±é—®é¢˜**

1. **å®¹å™¨æ–‡ä»¶ç³»ç»Ÿçš„ä¸´æ—¶æ€§**
   Docker å®¹å™¨çš„é»˜è®¤æ–‡ä»¶ç³»ç»ŸåŸºäºè”åˆæ–‡ä»¶ç³»ç»Ÿï¼ˆUnionFSï¼‰ï¼Œå…¶è®¾è®¡åŸåˆ™æ˜¯ â€‹**â€‹ ä¸å¯å˜æ€§ â€‹**â€‹ï¼š

   - å®¹å™¨åœæ­¢æˆ–åˆ é™¤æ—¶ï¼Œæ‰€æœ‰å†™å…¥å®¹å™¨å±‚çš„æ•°æ®å‡è¢«æ¸…é™¤
   - å¯¹æ•°æ®åº“ï¼ˆå¦‚ MySQLï¼‰ã€æ–‡ä»¶æœåŠ¡ç­‰æœ‰çŠ¶æ€åº”ç”¨ï¼Œæ•°æ®ä¸¢å¤±å°†å¯¼è‡´ä¸šåŠ¡ä¸­æ–­ã€‚

2. **æ•°æ®å·çš„æŒä¹…åŒ–èƒ½åŠ›**

   - æ•°æ®å·ç‹¬ç«‹äºå®¹å™¨ç”Ÿå‘½å‘¨æœŸï¼Œå­˜å‚¨äºå®¿ä¸»æœºæˆ–ç½‘ç»œå­˜å‚¨ä¸­ã€‚

   - å³ä½¿å®¹å™¨é‡å»ºï¼Œæ•°æ®ä»å¯ä¿ç•™ï¼ˆä¾‹å¦‚ MySQL çš„ `/var/lib/mysql` ç›®å½•é€šè¿‡å·æŒ‚è½½ï¼‰

**äºŒã€æ”¯æŒå®¹å™¨é—´æ•°æ®å…±äº«ä¸åä½œ**

1. **è·¨å®¹å™¨æ•°æ®åŒæ­¥éœ€æ±‚**
   - å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œå¤šä¸ªå®¹å™¨éœ€è®¿é—®åŒä¸€æ•°æ®é›†ï¼ˆå¦‚é…ç½®æ–‡ä»¶ã€æ—¥å¿—ç›®å½•ï¼‰ã€‚
   - ç¤ºä¾‹ï¼šWeb æœåŠ¡å™¨ä¸æ—¥å¿—å¤„ç†å®¹å™¨å…±äº«æ—¥å¿—ç›®å½•
2. **æ•°æ®å·çš„å…±äº«æœºåˆ¶**
   - å¤šä¸ªå®¹å™¨å¯æŒ‚è½½åŒä¸€æ•°æ®å·ï¼ˆå‘½åå·æˆ–ç»‘å®šæŒ‚è½½ï¼‰ï¼Œå®ç°å®æ—¶æ•°æ®åŒæ­¥
   - æ•°æ®å·å®¹å™¨ï¼ˆData Volume Containerï¼‰æ¨¡å¼å¯é›†ä¸­ç®¡ç†å…±äº«å·

**ğŸ“ˆ ä¸‰ã€æå‡æ€§èƒ½ä¸ç®¡ç†æ•ˆç‡**

1. **I/O æ€§èƒ½ä¼˜åŒ–**

   - å®¹å™¨å†…æ–‡ä»¶ç³»ç»Ÿçš„è¯»å†™æ€§èƒ½ä½äºå®¿ä¸»æœºæœ¬åœ°å­˜å‚¨ï¼ˆUnionFS å åŠ å±‚æŸè€—ï¼‰

   - æ•°æ®å·ç›´æ¥æ˜ å°„å®¿ä¸»æœºæ–‡ä»¶ç³»ç»Ÿï¼Œè¯»å†™é€Ÿåº¦æå‡æ˜¾è‘—ï¼ˆå°¤å…¶é€‚ç”¨äºæ•°æ®åº“é«˜å¹¶å‘åœºæ™¯ï¼‰

2. **è¿ç»´ä¾¿æ·æ€§**

   - å¤‡ä»½/è¿ç§»ï¼šç›´æ¥æ“ä½œå®¿ä¸»æœºå·ç›®å½•å³å¯å¤‡ä»½ï¼ˆå¦‚ `tar` æ‰“åŒ…ï¼‰ã€‚
   - æƒé™æ§åˆ¶ï¼šå¯è®¾ç½®åªè¯»ï¼ˆ`ro`ï¼‰æˆ–è¯»å†™ï¼ˆ`rw`ï¼‰æƒé™ï¼Œé˜²æ­¢è¯¯æ“ä½œ

### 2. æ•°æ®å·çš„ç‰¹ç‚¹

- æ•°æ®å·å­˜åœ¨äºå®¿ä¸»æœºçš„æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œç‹¬ç«‹äºå®¹å™¨ï¼Œå’Œå®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸæ˜¯åˆ†ç¦»çš„
- æ•°æ®å·å¯ä»¥ç›®å½•ä¹Ÿå¯ä»¥æ˜¯æ–‡ä»¶ï¼Œå®¹å™¨å¯ä»¥åˆ©ç”¨æ•°æ®å·ä¸å®¿ä¸»æœºè¿›è¡Œæ•°æ®å…±äº«ï¼Œå®ç°äº†å®¹å™¨é—´çš„æ•°æ®å…±äº«å’Œäº¤æ¢
- å®¹å™¨å¯åŠ¨åˆå§‹åŒ–æ—¶ï¼Œå¦‚æœå®¹å™¨ä½¿ç”¨çš„é•œåƒåŒ…å«äº†æ•°æ®ï¼Œè¿™äº›æ•°æ®ä¼šæ‹·è´åˆ°æ•°æ®å·ä¸­
- å®¹å™¨å¯¹æ•°æ®å·çš„ä¿®æ”¹æ˜¯å®æ—¶è¿›è¡Œçš„
- æ•°æ®å·çš„å˜åŒ–ä¸ä¼šå½±å“é•œåƒçš„æ›´æ–°ã€‚æ•°æ®å·æ˜¯ç‹¬ç«‹äºè”åˆæ–‡ä»¶ç³»ç»Ÿï¼Œé•œåƒæ˜¯åŸºäºè”åˆæ–‡ä»¶ç³»ç»Ÿã€‚é•œåƒä¸æ•°æ®å·ä¹‹é—´ä¸ä¼šæœ‰ç›¸äº’å½±å“ã€‚

### 3. Docker æŒ‚è½½å®¹å™¨æ•°æ®å·çš„ä¸‰ç§æ–¹å¼

- bind mountsï¼šå°†å®¿ä¸»æœºä¸Šçš„ä¸€ä¸ªæ–‡ä»¶æˆ–ç›®å½•è¢«æŒ‚è½½åˆ°å®¹å™¨ä¸Šã€‚
- volumesï¼šç”± Docker åˆ›å»ºå’Œç®¡ç†ã€‚ä½¿ç”¨ docker volume å‘½ä»¤ç®¡ç†
- tmpfs mountsï¼štmpfs æ˜¯ä¸€ç§åŸºäºå†…å­˜çš„ä¸´æ—¶æ–‡ä»¶ç³»ç»Ÿã€‚tmpfs mounts æ•°æ®ä¸ä¼šå­˜å‚¨åœ¨ç£ç›˜ä¸Šã€‚

![img](https://i-blog.csdnimg.cn/blog_migrate/934ada8aeff31c8904cf46a9c54ed2d7.png)

#### 1. **å·æŒ‚è½½ï¼ˆVolume Mountsï¼‰**

**ç‰¹ç‚¹**ï¼š

- **Docker æ‰˜ç®¡å­˜å‚¨**ï¼šæ•°æ®å·å­˜å‚¨åœ¨å®¿ä¸»æœºå›ºå®šè·¯å¾„ï¼ˆé»˜è®¤ `/var/lib/docker/volumes/`ï¼‰
- **æŒä¹…åŒ–ä¸å…±äº«**ï¼šåˆ é™¤å®¹å™¨åæ•°æ®ä»ä¿ç•™ï¼Œæ”¯æŒå¤šå®¹å™¨æŒ‚è½½åŒä¸€å·
- **ç›®å½•åˆå§‹å†…å®¹å¯è§**ï¼šæŒ‚è½½æ—¶å®¹å™¨å†…ç›®æ ‡ç›®å½•çš„**åŸå§‹æ–‡ä»¶ä¸ä¼šè¢«è¦†ç›–**ï¼ˆä¸ç»‘å®šæŒ‚è½½çš„å…³é”®åŒºåˆ«ï¼‰

**æ“ä½œå‘½ä»¤**

```bash
# åˆ›å»ºå‘½åå·
docker volume create my_vol
# æŒ‚è½½åˆ°å®¹å™¨
docker run -v my_vol:/å®¹å™¨è·¯å¾„ é•œåƒå
# æˆ–ä½¿ç”¨ --mountï¼ˆæ¨èç²¾ç¡®æ§åˆ¶ï¼‰
docker run --mount source=my_vol,target=/å®¹å™¨è·¯å¾„ é•œåƒå
```

**é€‚ç”¨åœºæ™¯**: ç”Ÿäº§ç¯å¢ƒæ•°æ®åº“ï¼ˆå¦‚ MySQLï¼‰ã€éœ€é•¿æœŸä¿å­˜çš„é…ç½®æ–‡ä»¶.

#### 2. **ç»‘å®šæŒ‚è½½ï¼ˆBind Mountsï¼‰**

**ç‰¹ç‚¹**ï¼š

- **ç›´æ¥æ˜ å°„å®¿ä¸»æœºè·¯å¾„**ï¼šå°†ä»»æ„å®¿ä¸»æœºç›®å½•æŒ‚è½½åˆ°å®¹å™¨ï¼ˆå¦‚ `/home/user/data:/å®¹å™¨è·¯å¾„`ï¼‰
- **è¦†ç›–ç›®æ ‡ç›®å½•å†…å®¹**ï¼šå®¹å™¨å†…æŒ‚è½½ç‚¹çš„**åŸå§‹æ–‡ä»¶ä¼šè¢«éšè—**ï¼Œä»…æ˜¾ç¤ºå®¿ä¸»æœºç›®å½•å†…å®¹
- **çµæ´»ä½†ä¾èµ–å®¿ä¸»æœºç»“æ„**ï¼šè·¯å¾„éœ€é¢„å…ˆå­˜åœ¨ï¼Œè·¨ä¸»æœºç§»æ¤æ€§å·®

**æ“ä½œå‘½ä»¤**

```bash
docker run -v /å®¿ä¸»æœºç»å¯¹è·¯å¾„:/å®¹å™¨è·¯å¾„[:ro] é•œåƒå  # ro è¡¨ç¤ºåªè¯»
```

**é€‚ç”¨åœºæ™¯**: å¼€å‘è°ƒè¯•ï¼ˆä»£ç çƒ­æ›´æ–°ï¼‰ã€å®¿ä¸»æœºä¸å®¹å™¨å®æ—¶å…±äº«æ•°æ®

#### 3. ä¸´æ—¶æ–‡ä»¶ç³»ç»ŸæŒ‚è½½ï¼ˆtmpfs Mountsï¼‰

**ç‰¹ç‚¹**ï¼š

- **å†…å­˜å­˜å‚¨**ï¼šæ•°æ®ä»…å­˜äºå®¿ä¸»æœºå†…å­˜ï¼Œ**å®¹å™¨åœæ­¢å³ä¸¢å¤±**
- **ä¸å†™ç£ç›˜**ï¼šé¿å…æ•æ„Ÿæ•°æ®æ³„éœ²ï¼Œè¯»å†™é€Ÿåº¦æœ€å¿«
- **çµæ´»ä½†ä¾èµ–å®¿ä¸»æœºç»“æ„**ï¼šè·¯å¾„éœ€é¢„å…ˆå­˜åœ¨ï¼Œè·¨ä¸»æœºç§»æ¤æ€§å·®

**æ“ä½œå‘½ä»¤**

```bash
docker run --tmpfs /å®¹å™¨è·¯å¾„ é•œåƒå
# æˆ–é™åˆ¶å¤§å°
docker run --mount type=tmpfs,destination=/å®¹å™¨è·¯å¾„,tmpfs-size=100M é•œåƒå
```

**é€‚ç”¨åœºæ™¯**: ä¸´æ—¶ç¼“å­˜ï¼ˆå¦‚ä¼šè¯æ•°æ®ï¼‰ã€å¤„ç†æ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚å¯†é’¥ï¼‰

#### 4. **ä¸‰ç§æ–¹å¼å¯¹æ¯”æ€»ç»“**

|        **ç‰¹æ€§**        |           å·æŒ‚è½½           |          ç»‘å®šæŒ‚è½½          |        tmpfs æŒ‚è½½        |
| :--------------------: | :------------------------: | :------------------------: | :----------------------: |
|     **æ•°æ®æŒä¹…æ€§**     |        âœ… æ°¸ä¹…ä¿å­˜         |        âœ… æ°¸ä¹…ä¿å­˜         |    âŒ å®¹å™¨åœæ­¢å³ä¸¢å¤±     |
|        **æ€§èƒ½**        | â­â­â­ï¼ˆç»•è¿‡è”åˆæ–‡ä»¶ç³»ç»Ÿï¼‰ | â­â­â­â­ï¼ˆç›´æ¥è¯»å†™å®¿ä¸»æœºï¼‰ | â­â­â­â­â­ï¼ˆå†…å­˜çº§é€Ÿåº¦ï¼‰ |
| **ç›®å½•åˆå§‹å†…å®¹å¯è§æ€§** |     å¯è§**3\*\***4\*\*     |     éšè—**3\*\***9\*\*     |            -             |
|       **ç§»æ¤æ€§**       |  â­â­â­â­ï¼ˆDocker æ‰˜ç®¡ï¼‰   |   â­â­ï¼ˆä¾èµ–å®¿ä¸»æœºè·¯å¾„ï¼‰   |         â­â­â­â­         |
|      **å…¸å‹åœºæ™¯**      |      æ•°æ®åº“ã€ç”Ÿäº§é…ç½®      |    å¼€å‘è°ƒè¯•ã€ä»£ç çƒ­æ›´æ–°    |    æ•æ„Ÿæ•°æ®ã€ä¸´æ—¶ç¼“å­˜    |

#### 5. **å…³é”®æ³¨æ„äº‹é¡¹**

**æƒé™æ§åˆ¶**ï¼š

- ç»‘å®šæŒ‚è½½æˆ–å·æŒ‚è½½å‡å¯é€šè¿‡ `:ro` è®¾ç½®ä¸ºåªè¯»ï¼ˆå¦‚ `-v my_vol:/data:ro`

**ç›®å½•è¦†ç›–é£é™©**ï¼š

- ç»‘å®šæŒ‚è½½ä¼š**éšè—å®¹å™¨å†…ç›®æ ‡ç›®å½•çš„åŸå§‹æ–‡ä»¶**ï¼ŒåŠ¡å¿…ç¡®è®¤æ˜¯å¦éœ€è¦ä¿ç•™

**æ•°æ®æ¸…ç†**ï¼š

- å‘½åå·éœ€æ‰‹åŠ¨åˆ é™¤ï¼š`docker volume rm my_vol`
- ç»‘å®šæŒ‚è½½æ•°æ®éœ€æ‰‹åŠ¨æ¸…ç†å®¿ä¸»æœºç›®å½•

## 3. Dockerfile

#### 1.ä»€ä¹ˆæ˜¯ Dockerfile

Dockerfile æ˜¯ **Docker é•œåƒçš„è‡ªåŠ¨åŒ–æ„å»ºè„šæœ¬**ï¼Œæœ¬è´¨æ˜¯ä¸€ä¸ªçº¯æ–‡æœ¬æ–‡ä»¶ï¼ˆæ— åç¼€åï¼Œé€šå¸¸å‘½åä¸º `Dockerfile`ï¼‰ï¼Œå…¶ä¸­åŒ…å«ä¸€ç³»åˆ—æŒ‰é¡ºåºæ‰§è¡Œçš„æŒ‡ä»¤ã€‚è¿™äº›æŒ‡ä»¤å®šä¹‰äº†å¦‚ä½•ä»åŸºç¡€é•œåƒå¼€å§‹ï¼Œé€æ­¥æ·»åŠ é…ç½®ã€ä¾èµ–å’Œä»£ç ï¼Œæœ€ç»ˆç”Ÿæˆä¸€ä¸ªå¯è¿è¡Œçš„å®¹å™¨é•œåƒ

#### 2. Dockerfile ä½¿ç”¨

##### 2.1**æ ¸å¿ƒæŒ‡ä»¤è¯¦è§£**

| **æŒ‡ä»¤**     | **ç”¨é€”**                             | **ç¤ºä¾‹**                                 |
| :----------- | :----------------------------------- | :--------------------------------------- |
| `FROM`       | æŒ‡å®šåŸºç¡€é•œåƒ                         | `FROM ubuntu:22.04`                      |
| `RUN`        | æ‰§è¡Œå‘½ä»¤ï¼ˆå®‰è£…è½¯ä»¶ç­‰ï¼‰               | `RUN apt update && apt install -y nginx` |
| `COPY`       | å¤åˆ¶æœ¬åœ°æ–‡ä»¶åˆ°é•œåƒ                   | `COPY ./app /usr/share/nginx/html`       |
| `ADD`        | ç±»ä¼¼ COPYï¼Œæ”¯æŒè§£å‹/URL              | `ADD https://example.com/file.tar /data` |
| `WORKDIR`    | è®¾ç½®å·¥ä½œç›®å½•                         | `WORKDIR /app`                           |
| `ENV`        | è®¾ç½®ç¯å¢ƒå˜é‡                         | `ENV NODE_ENV=production`                |
| `EXPOSE`     | å£°æ˜å®¹å™¨è¿è¡Œæ—¶ç«¯å£                   | `EXPOSE 80`                              |
| `CMD`        | **å®¹å™¨å¯åŠ¨æ—¶æ‰§è¡Œçš„å‘½ä»¤**ï¼ˆå¯è¢«è¦†ç›–ï¼‰ | `CMD ["nginx", "-g", "daemon off;"]`     |
| `ENTRYPOINT` | **å®¹å™¨å…¥å£å‘½ä»¤**ï¼ˆä¸æ˜“è¢«è¦†ç›–ï¼‰       | `ENTRYPOINT ["python", "app.py"]`        |
| `USER`       | æŒ‡å®šè¿è¡Œç”¨æˆ·                         | `USER node`                              |
| `VOLUME`     | åˆ›å»ºæ•°æ®å·æŒ‚è½½ç‚¹                     | `VOLUME /data`                           |

##### 2.2 **Dockerfile ç¤ºä¾‹**

```bash

# åˆ›å»ºæ–‡ä»¶å¤¹ df_dir
mkdir df_dir
# è¿›å…¥ æ–‡ä»¶å¤¹ df_dir
cd df_dir
# vi ç¼–è¾‘å™¨æ‰“å¼€ä¸€ä¸ªåä¸º Dockerfile çš„æ–‡ä»¶
vi Dockerfile
#  è¦è¿›å…¥ç¼–è¾‘æ¨¡å¼ aï¼šè¿›å…¥æ’å…¥æ¨¡å¼ã€‚è¾“å…¥å†…å®¹
# æµ‹è¯•Dockerfile
FROM centos
# è¾“å‡º
RUN echo "æµ‹è¯•çš„Dockerfile"

#æŒ‰ Esc é”®é€€å‡ºç¼–è¾‘æ¨¡å¼å›åˆ°å‘½ä»¤æ¨¡å¼ã€‚è¾“å…¥ :wq ç„¶åæŒ‰ Enter é”®
#æŸ¥çœ‹ Dockerfile
[root@lavm-zo7f3xq5c6 df_dir]# cat  Dockerfile
# æµ‹è¯•Dockerfile
FROM centos
RUN echo â€˜æµ‹è¯•çš„Dockerfileâ€™
# æŸ¥çœ‹è·¯å¾„
[root@lavm-zo7f3xq5c6 df_dir]# pwd
/root/df_dir
# æ‰“åŒ…é•œåƒ
[root@lavm-zo7f3xq5c6 df_dir]# docker build /root/df_dir
[+] Building 0.4s (4/5)                                                                                                                              docker:default
[+] Building 0.5s (4/5)                                                                                                                              docker:default
 => [internal] load build definition from Dockerfile                                                                                                           0.1s
[+] Building 0.6s (5/6)                                                                                                                              docker:default
[+] Building 0.7s (6/6)                                                                                                                              docker:default
[+] Building 0.8s (6/6) FINISHED                                                                                                                     docker:default
 => [internal] load build definition from Dockerfile                                                                                                           0.1s
 => => transferring dockerfile: 103B                                                                                                                           0.0s. => [internal] load metadata for docker.io/library/centos:latest                                                                                               0.0s. => [internal] load .dockerignore                                                                                                                 #æ‰§è¡Œæ­¥éª¤
 => => transferring context: 2B                                                                                                                                0.0s. => [1/2] FROM docker.io/library/centos:latest                                                                                                                 0.0s. => [2/2] RUN echo â€˜æµ‹è¯•çš„Dockerfileâ€™                                                                                                                             0.3s> exporting to image                                                                                                                                         0.2s

 => => writing image sha256:7eb8703a9e804f8c9f4e136d1b3a4530070584a8216d62933caa61c7b69d726d        # æŸ¥çœ‹ç”Ÿæˆçš„é•œåƒ                                                           0.0s
[root@lavm-zo7f3xq5c6 df_dir]# docker images
# 7eb8703a9e80 æ²¡æœ‰ç”Ÿæˆåç§°
REPOSITORY     TAG       IMAGE ID       CREATED         SIZE
<none>         <none>    7eb8703a9e80   3 minutes ago   202MB
centos-netv2   1.0       6d0baed20aad   6 days ago      319MB


```

**å†æ¬¡æ„å»º**

ç¬¬äºŒæ¬¡æ„å»ºï¼Œå› ä¸ºæ˜¯åŒä¸€ä¸ª Dockerfileï¼ŒDockerfile ä¹Ÿæ²¡æœ‰ä¿®æ”¹ã€‚ç›´æ¥æŠŠä¹‹å‰æ„å»ºçš„é•œåƒé‡å‘½åã€‚é•œåƒ id ä¹Ÿä¸å˜ã€‚

```bash
# å†æ¬¡æ„å»º æ·»åŠ é•œåƒåç§°
[root@lavm-zo7f3xq5c6 df_dir]# docker build /root/df_dir -t test-images:v1.0
[+] Building 0.1s (6/6)                                                                                                                              docker:default
[+] Building 0.2s (6/6) FINISHED                                                                                                                     docker:default
 => [internal] load build definition from Dockerfile                                                                                                           0.0s
 => => transferring dockerfile: 103B                                                                                                                           0.0s
 => [internal] load metadata for docker.io/library/centos:latest                                                                                               0.0s
 => [internal] load .dockerignore                                                                                                                              0.0s
 => => transferring context: 2B                                                                                                                                0.0s
 => [1/2] FROM docker.io/library/centos:latest                                                                                                                 0.0s. => CACHED [2/2] RUN echo â€˜æµ‹è¯•çš„Dockerfileâ€™                                                                                                                      0.0s> exporting to image                                                                                                                                         0.1s
 => exporting to image                                                                                                                                         0.1s
 => => exporting layers                                                                                                                                        0.0s
 => => writing image sha256:7eb8703a9e804f8c9f4e136d1b3a4530070584a8216d62933caa61c7b69d726d                                                                   0.0s
 => => naming to docker.io/library/test-images:v1.0                                                                                                            0.0s

[root@lavm-zo7f3xq5c6 df_dir]# docker images
REPOSITORY     TAG       IMAGE ID       CREATED         SIZE
test-images    v1.0      7eb8703a9e80   7 minutes ago   202MB
centos-netv2   1.0       6d0baed20aad   6 days ago      319MB

```

#### 3. Dockerfile æ ¸å¿ƒç‰¹å¾

##### **1. å£°æ˜å¼è¯­æ³•**

- **æŒ‡ä»¤åŒ–ç»“æ„**ï¼šä½¿ç”¨ç®€å•æŒ‡ä»¤ï¼ˆå¦‚ `FROM`, `COPY`, `RUN`ï¼‰æè¿°æ„å»ºæ­¥éª¤
- **è‡ªæ–‡æ¡£åŒ–**ï¼šæ–‡ä»¶æœ¬èº«æ¸…æ™°å±•ç¤ºç¯å¢ƒé…ç½®æµç¨‹

```bash
# dockerfile
FROM node:18
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
```

##### **2. åˆ†å±‚æ„å»ºæœºåˆ¶**

- **é•œåƒå±‚ç¼“å­˜**ï¼šæ¯æ¡æŒ‡ä»¤ç”Ÿæˆç‹¬ç«‹åªè¯»å±‚ï¼Œæœªä¿®æ”¹å±‚å¯å¤ç”¨
- **æ„å»ºä¼˜åŒ–**ï¼šå˜åŠ¨é¢‘ç‡ä½çš„æŒ‡ä»¤ï¼ˆå¦‚ä¾èµ–å®‰è£…ï¼‰åº”æ”¾åœ¨æ–‡ä»¶å‰éƒ¨

```bash
docker history <image_name>
```

##### **3. ç¯å¢ƒéš”ç¦»æ€§**

- **å°é—­æ„å»ºç¯å¢ƒ**ï¼šåœ¨çº¯å‡€ä¸Šä¸‹æ–‡ä¸­æ‰§è¡ŒæŒ‡ä»¤
- **ä¾èµ–æ§åˆ¶**ï¼šä»…åŒ…å«æ˜¾å¼å£°æ˜çš„ä¾èµ–é¡¹
- **ä¸Šä¸‹æ–‡éš”ç¦»**ï¼šé€šè¿‡ `.dockerignore` æ’é™¤æ— å…³æ–‡ä»¶

##### **4. å¯ç§»æ¤æ€§**

- **å¹³å°æ— å…³**ï¼šå¯åœ¨ä»»ä½• Docker ç¯å¢ƒä¸­æ„å»ºç›¸åŒé•œåƒ
- **ç¯å¢ƒä¸€è‡´æ€§**ï¼šæ¶ˆé™¤ "åœ¨æˆ‘æœºå™¨ä¸Šèƒ½è¿è¡Œ" é—®é¢˜
- **ç‰ˆæœ¬æ§åˆ¶**ï¼šDockerfile å¯çº³å…¥ Git ä»“åº“ç®¡ç†

##### **5. å¯é‡å¤æ„å»º**

- **å¹‚ç­‰æ€§**ï¼šç›¸åŒ Dockerfile å§‹ç»ˆç”Ÿæˆç›¸åŒé•œåƒï¼ˆéœ€å›ºå®šåŸºç¡€é•œåƒç‰ˆæœ¬ï¼‰
- **ç¡®å®šæ€§æ„å»º**ï¼šä¸å—å®¿ä¸»æœºç¯å¢ƒå½±å“

```bash
# dockerfile
# æ¨èæ˜ç¡®ç‰ˆæœ¬
FROM python:3.11.4-slim-bookworm
```

##### **6. ç”Ÿå‘½å‘¨æœŸé›†æˆ**

- **å¯åŠ¨æ§åˆ¶**ï¼šé€šè¿‡ `CMD`/`ENTRYPOINT` å®šä¹‰å®¹å™¨å¯åŠ¨è¡Œä¸º
- **æœåŠ¡æš´éœ²**ï¼šä½¿ç”¨ `EXPOSE` å£°æ˜ç½‘ç»œç«¯å£
- **æŒä¹…åŒ–é…ç½®**ï¼š`VOLUME` æŒ‡ä»¤å®šä¹‰æ•°æ®å·æŒ‚è½½ç‚¹

## 4. DockerCompose

### 1. Docker Compose æ˜¯ä»€ä¹ˆ

- Compose é€šè¿‡ä¸€ä¸ªé…ç½®æ–‡ä»¶æ¥ç®¡ç†å¤šä¸ª Docker å®¹å™¨.
- åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œæ‰€æœ‰çš„å®¹å™¨é€šè¿‡ services æ¥å®šä¹‰ï¼Œç„¶åä½¿ç”¨ docker-compose è„šæœ¬æ¥å¯åŠ¨ã€åœæ­¢å’Œé‡å¯åº”ç”¨å’Œåº”ç”¨ä¸­çš„æœåŠ¡ä»¥åŠæ‰€æœ‰ä¾èµ–æœåŠ¡çš„å®¹å™¨

- æ­¥éª¤:
  - æœ€åï¼Œè¿è¡Œ`docker-compose up`ï¼ŒCompose å°†å¯åŠ¨å¹¶è¿è¡Œæ•´ä¸ªåº”ç”¨ç¨‹åº é…ç½®æ–‡ä»¶ç»„æˆ
  - services å¯ä»¥å®šä¹‰éœ€è¦çš„æœåŠ¡ï¼Œæ¯ä¸ªæœåŠ¡éƒ½æœ‰è‡ªå·±çš„åå­—ã€ä½¿ç”¨çš„é•œåƒã€æŒ‚è½½çš„æ•°æ®å·æ‰€å±çš„ç½‘ç»œå’Œä¾èµ–çš„å…¶å®ƒæœåŠ¡
  - networks æ˜¯åº”ç”¨çš„ç½‘ç»œï¼Œåœ¨å®ƒä¸‹é¢å¯ä»¥å®šä¹‰ä½¿ç”¨çš„ç½‘ç»œåç§°ï¼Œç±»æ€§
  - volumes æ˜¯æ•°æ®å·ï¼Œå¯ä»¥åœ¨æ­¤å®šä¹‰æ•°æ®å·ï¼Œç„¶åæŒ‚è½½åˆ°ä¸åŒçš„æœåŠ¡ä¸Šé¢ä½¿ç”¨

### 2. å®‰è£… compose

**Linux Docker Compose CLI æ’ä»¶**

```bash
# ä» GitHub ä¸‹è½½æœ€æ–°ç‰ˆ Docker Compose çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼š
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose

# èµ‹äºˆæ‰§è¡Œæƒé™
sudo chmod +x /usr/local/bin/docker-compose

# å°†äºŒè¿›åˆ¶æ–‡ä»¶é“¾æ¥åˆ° /usr/bin ç›®å½•ï¼Œæ–¹ä¾¿å…¨å±€è°ƒç”¨
sudo ln -s /usr/local/bin/docker-compose /usr/bin/docker-compose

# æŸ¥çœ‹
docker-compose --version


```

### 3.Docker Compose File

Docker Compose æ–‡ä»¶ï¼ˆé€šå¸¸å‘½åä¸º `docker-compose.yml`ï¼‰æ˜¯ä¸€ä¸ª **YAML æ ¼å¼çš„é…ç½®æ–‡ä»¶**ï¼Œç”¨äºå®šä¹‰å’Œè¿è¡Œå¤šå®¹å™¨ Docker åº”ç”¨ç¨‹åºã€‚å®ƒæè¿°äº†åº”ç”¨ç¨‹åºçš„æœåŠ¡ã€ç½‘ç»œã€å·ç­‰ç»„ä»¶åŠå…¶å…³ç³»

**Docker Compose File é¡¶çº§é…ç½®é¡¹**

- versionï¼šæŒ‡å®š Docker Compose File ç‰ˆæœ¬å·

- servicesï¼šå®šä¹‰å¤šä¸ªæœåŠ¡å¹¶é…ç½®å¯åŠ¨å‚æ•°
- volumesï¼šå£°æ˜æˆ–åˆ›å»ºåœ¨å¤šä¸ªæœåŠ¡ä¸­å…±åŒä½¿ç”¨çš„æ•°æ®å·å¯¹è±¡

- networksï¼šå®šä¹‰åœ¨å¤šä¸ªæœåŠ¡ä¸­å…±åŒä½¿ç”¨çš„ç½‘ç»œå¯¹è±¡

- configsï¼šå£°æ˜å°†åœ¨æœ¬æœåŠ¡ä¸­è¦ä½¿ç”¨çš„ä¸€äº›é…ç½®æ–‡ä»¶

- secretsï¼šå£°æ˜å°†åœ¨æœ¬æœåŠ¡ä¸­è¦ä½¿ç”¨çš„ä¸€äº›ç§˜é’¥ã€å¯†ç æ–‡ä»¶
- x-\*\*\*ï¼šè‡ªå®šä¹‰é…ç½®ã€‚ä¸»è¦ç”¨äºå¤ç”¨ç›¸åŒçš„é…ç½®

**ç¤ºä¾‹**

```yaml
# Docker Compose File æœ‰å¤šä¸ªç‰ˆæœ¬ï¼ŒåŸºæœ¬æ˜¯å‘åå…¼å®¹çš„ï¼Œä½†ä¹Ÿæœ‰æä¸ªåˆ«é…ç½®é¡¹é«˜ç‰ˆæœ¬ä¸­æ²¡æœ‰
# åœ¨docker-compose.ymlä¸€å¼€å§‹å°±éœ€è¦åˆ©ç”¨versionå…³é”®è¯æ ‡æ˜å½“å‰fileä½¿ç”¨çš„ç‰ˆæœ¬
version: "3.8" # å®šä¹‰ Compose æ–‡ä»¶çš„ç‰ˆæœ¬ï¼Œå†³å®šä½¿ç”¨çš„è¯­æ³•å’ŒåŠŸèƒ½
# åœ¨ services éƒ¨åˆ†ï¼Œä½ å®šä¹‰äº†åº”ç”¨ä¸­è¿è¡Œçš„æ¯ä¸ªå®¹å™¨ï¼ˆæœåŠ¡ï¼‰ã€‚æ¯ä¸ªæœåŠ¡é€šå¸¸ä¼šåŒ…å«é•œåƒã€ç«¯å£æ˜ å°„ã€ç¯å¢ƒå˜é‡ã€å·æŒ‚è½½ç­‰é…ç½®
services:
  # web: è¿™ä¸ªæœåŠ¡ä½¿ç”¨ nginx:latest é•œåƒï¼Œå¹¶å°†å®¿ä¸»æœºçš„ 8080 ç«¯å£æ˜ å°„åˆ°å®¹å™¨çš„ 80 ç«¯å£ã€‚åŒæ—¶ï¼Œå®ƒå°†å®¿ä¸»æœºçš„ ./html ç›®å½•æŒ‚è½½åˆ°å®¹å™¨ä¸­çš„ /usr/share/nginx/htmlï¼Œå…è®¸è‡ªå®šä¹‰ç½‘é¡µå†…å®¹
  web:
    image: nginx:latest
    # ç«¯å£æ˜ å°„
    ports:
      - "8080:80"
    volumes:
      - ./html:/usr/share/nginx/html
    networks:
      - webnet
  # db: ä½¿ç”¨ MySQL é•œåƒï¼Œç¯å¢ƒå˜é‡è®¾ç½®äº†æ•°æ®åº“çš„ root å¯†ç ï¼Œä½¿ç”¨åä¸º mysql_data çš„å·å­˜å‚¨æ•°æ®
  db:
    image: mysql:5.7
    environment:
      MYSQL_ROOT_PASSWORD: example
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - webnet
# åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰çš„ç½‘ç»œ webnetï¼Œè®© web å’Œ db æœåŠ¡åœ¨åŒä¸€ä¸ªç½‘ç»œä¸­è¿›è¡Œé€šä¿¡
networks:
  webnet:
# å®šä¹‰äº†ä¸€ä¸ªåä¸º mysql_data çš„å·ï¼Œä¿å­˜ MySQL æ•°æ®ï¼Œç¡®ä¿æ•°æ®æŒä¹…åŒ–
volumes:
  mysql_data:
```

**åŸºç¡€å¯åŠ¨å‘½ä»¤**

```bash
# è¿›å…¥åŒ…å« docker-compose.yml çš„ç›®å½•
cd /path/to/your/project

# å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆå‰å°è¿è¡Œï¼Œæ—¥å¿—è¾“å‡ºåˆ°æ§åˆ¶å°ï¼‰
docker compose up

# åå°å¯åŠ¨ï¼ˆæ¨èï¼‰
docker compose up -d
```

### 4. å¯åŠ¨æœåŠ¡

**æ ¸å¿ƒæ“ä½œå‘½ä»¤**

| å‘½ä»¤                     | ä½œç”¨                    | ç¤ºä¾‹                         |
| :----------------------- | :---------------------- | :--------------------------- |
| `docker compose up`      | åˆ›å»ºå¹¶å¯åŠ¨æ‰€æœ‰æœåŠ¡      | `docker compose up -d`       |
| `docker compose down`    | åœæ­¢å¹¶ç§»é™¤æ‰€æœ‰å®¹å™¨/ç½‘ç»œ | `docker compose down -v`     |
| `docker compose start`   | å¯åŠ¨å·²å­˜åœ¨çš„æœåŠ¡å®¹å™¨    | `docker compose start web`   |
| `docker compose stop`    | åœæ­¢è¿è¡Œä¸­çš„å®¹å™¨        | `docker compose stop`        |
| `docker compose restart` | é‡å¯æœåŠ¡                | `docker compose restart web` |
| `docker compose ps`      | æŸ¥çœ‹æœåŠ¡çŠ¶æ€            | `docker compose ps`          |
| `docker compose logs`    | æŸ¥çœ‹æœåŠ¡æ—¥å¿—            | `docker compose logs -f web` |

## 5. Docker ä»“åº“

### 1. ä»€ä¹ˆæ˜¯ Docker ä»“åº“

- Docker ä»“åº“å°±æ˜¯å­˜æ”¾ docker é•œåƒå¹¶æœ‰ docker pull æ–¹æ³•ä¸‹è½½çš„äº‘ç¯å¢ƒ
- Docker ä»“åº“åˆ†ä¸ºå…¬æœ‰ä»“åº“å’Œç§æœ‰ä»“åº“
  - å…¬æœ‰ä»“åº“æŒ‡ Docker Hub(å®˜æ–¹)ç­‰å¼€æ”¾ç»™ç”¨æˆ·ä½¿ç”¨ã€å…è®¸ç”¨æˆ·ç®¡ç†é•œåƒ
  - ç§æœ‰ä»“åº“æŒ‡ç”±ç”¨æˆ·è‡ªè¡Œæ­å»ºçš„å­˜æ”¾é•œåƒçš„äº‘ç¯å¢ƒã€‚

### 2. Docker ç§æœ‰ä»“åº“æ­å»º

ç§æœ‰ä»“åº“æ­å»º:**å¸¦è®¤è¯ç§æœ‰ä»“åº“** å’Œ **æ— è®¤è¯ç§æœ‰ä»“åº“**.

**æ ¸å¿ƒåŒºåˆ«å¯¹æ¯”**

| **ç‰¹æ€§**       | **æ— è®¤è¯ç§æœ‰ä»“åº“**           | **å¸¦è®¤è¯ç§æœ‰ä»“åº“**         |
| :------------- | :--------------------------- | :------------------------- |
| **é€‚ç”¨åœºæ™¯**   | å¼€å‘æµ‹è¯•ã€å°é—­å†…ç½‘ç¯å¢ƒ       | å‡†ç”Ÿäº§ç¯å¢ƒã€å¤šç”¨æˆ·å…±äº«     |
| **å®‰å…¨æ€§**     | âš ï¸ ä½ï¼ˆå®Œå…¨å¼€æ”¾è®¿é—®ï¼‰        | ğŸ”’ ä¸­ï¼ˆåŸºç¡€è´¦å·å¯†ç ä¿æŠ¤ï¼‰  |
| **é…ç½®å¤æ‚åº¦** | â˜…â˜†â˜† ç®€å•                     | â˜…â˜…â˜† ä¸­ç­‰                   |
| **è®¤è¯æ–¹å¼**   | æ— éœ€è®¤è¯                     | Basic Auth æˆ– Token è®¤è¯   |
| **å®¢æˆ·ç«¯é…ç½®** | éœ€è®¾ç½® `insecure-registries` | éœ€ç™»å½• (`docker login`)    |
| **é•œåƒä¿æŠ¤**   | æ‰€æœ‰ç”¨æˆ·å¯ä»»æ„æ¨é€/æ‹‰å–      | éœ€å‡­è¯æ‰èƒ½æ“ä½œé•œåƒ         |
| **ç½‘ç»œè¦æ±‚**   | å¿…é¡»å†…ç½‘ç¯å¢ƒ                 | å¯é…ç½®å…¬ç½‘è®¿é—®ï¼ˆéœ€ HTTPSï¼‰ |

#### 2.1 **å¸¦è®¤è¯çš„ç§æœ‰ Docker ä»“åº“**

##### ä¸€ã€åˆ›å»ºé¡¹ç›®ç›®å½•

```bash
mkdir auth-registry && cd auth-registry
mkdir auth registry-data  # è®¤è¯æ–‡ä»¶å’Œå­˜å‚¨ç›®å½•
```

##### äºŒã€ç”Ÿæˆè®¤è¯æ–‡ä»¶

```bash
# åˆ›å»ºç”¨æˆ·åå¯†ç  (user: myuser, password: mypassword)
docker run --rm \
  --entrypoint htpasswd \
  httpd:2 -Bbn myuser mypassword > auth/htpasswd

# æŸ¥çœ‹ç”Ÿæˆçš„å‡­è¯
cat auth/htpasswd
# è¾“å‡ºï¼šmyuser:$apr1$... (åŠ å¯†å­—ç¬¦ä¸²)
```

##### ä¸‰ã€åˆ›å»º `docker-compose.yml`

```yaml
version: "3.8"

services:
  registry:
    image: registry:2
    container_name: secure-registry
    ports:
      - "5000:5000"
    environment:
      REGISTRY_AUTH: htpasswd # å¯ç”¨è®¤è¯
      REGISTRY_AUTH_HTPASSWD_REALM: "Registry Realm"
      REGISTRY_AUTH_HTPASSWD_PATH: /auth/htpasswd
      REGISTRY_STORAGE_DELETE_ENABLED: "true" # å…è®¸åˆ é™¤é•œåƒ
    volumes:
      - ./registry-data:/var/lib/registry # é•œåƒå­˜å‚¨
      - ./auth:/auth # è®¤è¯æ–‡ä»¶
```

##### å››ã€å¯åŠ¨æœåŠ¡

```bash
docker compose up -d
```

##### äº”ã€å®¢æˆ·ç«¯ç™»å½•

```bash

# ç™»å½•ç§æœ‰ä»“åº“
docker login your-server-ip:5000
# è¾“å…¥ç”¨æˆ·å myuser å’Œå¯†ç  mypassword

# éªŒè¯ç™»å½•å‡­è¯
cat ~/.docker/config.json
```

##### å…­ã€æµ‹è¯•è®¤è¯ä»“åº“

```bash
# æ¨é€é•œåƒ (éœ€å…ˆç™»å½•)
docker tag alpine your-server-ip:5000/secure-alpine
docker push your-server-ip:5000/secure-alpine

# æœªç™»å½•å°è¯•æ‹‰å– (åº”å¤±è´¥)
docker logout your-server-ip:5000
docker pull your-server-ip:5000/secure-alpine
# é”™è¯¯ï¼špull access denied, requires authentication
```

#### 2.2 æ— è®¤è¯ç§æœ‰ä»“åº“æ­å»º

##### ä¸€ã€åˆ›å»ºé¡¹ç›®ç›®å½•

```bash
mkdir private-registry && cd private-registry
```

##### äºŒã€åˆ›å»º `docker-compose.yml`

```yaml
version: "3.8"

services:
  registry:
    image: registry:2
    container_name: insecure-registry # æ˜ç¡®å‘½åè¡¨ç¤ºæ— è®¤è¯
    ports:
      - "5000:5000"
    environment:
      REGISTRY_STORAGE_DELETE_ENABLED: "true" # å…è®¸åˆ é™¤é•œåƒ
      REGISTRY_AUTH: "none" # å…³é”®ï¼šç¦ç”¨æ‰€æœ‰è®¤è¯
    volumes:
      - ./registry-data:/var/lib/registry # æŒä¹…åŒ–å­˜å‚¨é•œåƒæ•°æ®

# æ³¨æ„ï¼šä¸éœ€è¦å®šä¹‰ networksï¼Œä½¿ç”¨é»˜è®¤ç½‘ç»œå³å¯
```

ğŸ“Œ **å…³é”®é…ç½®è¯´æ˜**ï¼š

- `REGISTRY_AUTH: "none"`ï¼šç¦ç”¨æ‰€æœ‰è®¤è¯æœºåˆ¶
- `REGISTRY_STORAGE_DELETE_ENABLED: "true"`ï¼šå…è®¸åˆ é™¤é•œåƒ
- `./registry-data`ï¼šæœ¬åœ°ç›®å½•æŒä¹…åŒ–å­˜å‚¨é•œåƒ

##### ä¸‰ã€å¯åŠ¨ç§æœ‰ä»“åº“

```bash
#å¯åŠ¨
docker compose up -d
# éªŒè¯æ˜¯å¦è¿è¡Œ
docker compose ps
#æ˜¾ç¤º
NAME                  COMMAND                  SERVICE   STATUS              PORTS
insecure-registry     "/entrypoint.sh /etcâ€¦"   registry  running             0.0.0.0:5000->5000/tcp
```

##### å››ã€å®¢æˆ·ç«¯é…ç½®ï¼ˆæ¯å°éœ€è¦è®¿é—®çš„æœºå™¨ï¼‰

```bash
#  Linux/Mac ç¼–è¾‘ Docker é…ç½®æ–‡ä»¶ï¼š
sudo nano /etc/docker/daemon.json

# æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼ˆæ›¿æ¢ your-server-ip ä¸ºå®é™… IPï¼‰ï¼š
{
  "insecure-registries": ["your-server-ip:5000"]
}
# é‡å¯ Dockerï¼š
sudo systemctl restart docker
```

##### äº”ã€æµ‹è¯•ç§æœ‰ä»“åº“

**æ¨é€é•œåƒåˆ°ç§æœ‰ä»“åº“**

```bash
# æ‹‰å–æµ‹è¯•é•œåƒ
docker pull hello-world

# æ ‡è®°é•œåƒæŒ‡å‘ç§æœ‰ä»“åº“
docker tag hello-world your-server-ip:5000/my-hello

# æ¨é€é•œåƒ
docker push your-server-ip:5000/my-hello
```

**ä»ç§æœ‰ä»“åº“æ‹‰å–**

```bash
# åˆ é™¤æœ¬åœ°é•œåƒ
docker rmi your-server-ip:5000/my-hello

# ä»ç§æœ‰ä»“åº“æ‹‰å–
docker pull your-server-ip:5000/my-hello
```

##### å…­ã€ç®¡ç†ç§æœ‰ä»“åº“

```bash
# 1. æŸ¥çœ‹é•œåƒæ ‡ç­¾
curl http://your-server-ip:5000/v2/my-hello/tags/list
# 2. åˆ é™¤é•œåƒï¼ˆéœ€è¦ä¸¤æ­¥ï¼‰
# è·å–é•œåƒçš„ digest
curl -I -H "Accept: application/vnd.docker.distribution.manifest.v2+json" \
  http://your-server-ip:5000/v2/my-hello/manifests/latest

# ä»è¿”å›å¤´ä¸­å¤åˆ¶ Digest: å€¼ï¼ˆå¦‚ sha256:123...ï¼‰
docker exec insecure-registry bin/registry garbage-collect /etc/docker/registry/config.yml

# 3. æ¸…ç†æ—§æ•°æ®
# è¿›å…¥ä»“åº“å®¹å™¨
docker exec -it insecure-registry sh

# æ‰§è¡Œåƒåœ¾å›æ”¶
registry garbage-collect /etc/docker/registry/config.yml --delete-untagged=true
```

#### 2.3 æ¶æ„å¯¹æ¯”å›¾

**æ— è®¤è¯ä»“åº“**

```bash
+----------------+       +---------------------+
| Docker Client  | ----> | å¼€æ”¾ä»“åº“ (IP:5000)  |
| (ä»»æ„è®¿é—®)       |       +---------------------+
+----------------+               |
                          +------v------+
                          | æœ¬åœ°å­˜å‚¨     |
                          | registry-data|
                          +-------------+
```

**å¸¦è®¤è¯ä»“åº“**

```bash
+----------------+       +---------------------+       +---------------+
| Docker Client  | ----> | è®¤è¯ç½‘å…³            | ----> | ä»“åº“æœåŠ¡       |
| (éœ€docker login)|       | - éªŒè¯ htpasswd     |       +-------^-------+
+----------------+       +---------------------+               |
                                                        +------v------+
                                                        | æŒä¹…åŒ–å­˜å‚¨  |
                                                        | é•œåƒæ•°æ®    |
                                                        +------------+
```
